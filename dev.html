<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Access Payment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://applet.payherokenya.com/cdn/button_sdk.js?v=3.1"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen flex items-center justify-center font-sans">

  <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-md transition-transform hover:scale-[1.01]">
    <!-- Header -->
    <div class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold text-green-700 tracking-tight">20X Access Payment</h1>
      <p class="text-gray-600 mt-2 text-sm">
        Pay <span class="font-semibold text-green-700">KES 200 daily</span> to keep your access active.
      </p>
    </div>

    <!-- Form -->
    <div class="space-y-4">
      <div>
        <label for="phone" class="block text-sm font-medium text-gray-700 text-left">Phone Number</label>
        <input id="phone" type="text" placeholder="e.g. 07XXXXXXXX"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800">
      </div>

      <div>
        <label for="amount" class="block text-sm font-medium text-gray-700 text-left">Amount (KES)</label>
        <input id="amount" type="number" placeholder="Minimum 200"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800">
      </div>

      <button id="payBtn"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition duration-200 ease-in-out shadow-md">
        Proceed to Pay
      </button>
    </div>

    <!-- PayHero Container -->
    <div id="payHero" class="mt-6"></div>

    <!-- Status / Loading Section -->
    <div class="mt-5 text-center">
      <p id="status" class="text-gray-600 text-sm font-medium"></p>
      <div id="loader" class="hidden mt-3 flex justify-center">
        <div class="w-6 h-6 border-2 border-green-600 border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <!-- JS Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // üî• Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBtB199eH6fONCftI_B6IDP80_0Tv2dFN8",
      authDomain: "m-sales-45b35.firebaseapp.com",
      databaseURL: "https://m-sales-45b35-default-rtdb.firebaseio.com",
      projectId: "m-sales-45b35",
      storageBucket: "m-sales-45b35.appspot.com",
      messagingSenderId: "194892525308",
      appId: "1:194892525308:web:c01af3028c85abdb97f179"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const FIXED_ACCESS_CODE = "778899";

    const payBtn = document.getElementById("payBtn");
    const status = document.getElementById("status");
    const loader = document.getElementById("loader");

    // ‚úÖ Make Payment
    window.makePayment = () => {
      const phone = document.getElementById("phone").value.trim();
      const amount = parseFloat(document.getElementById("amount").value.trim());

      if (!phone || !/^07\d{8}$/.test(phone)) {
        status.textContent = "‚ö†Ô∏è Please enter a valid Safaricom phone number.";
        status.classList.add("text-red-600");
        return;
      }

      if (isNaN(amount) || amount <1000) {
        status.textContent = "‚ö†Ô∏è Minimum payment is KES 1000.";
        status.classList.add("text-red-600");
        return;
      }

      loader.classList.remove("hidden");
      status.textContent = "Initializing payment...";

      PayHero.init({
        paymentUrl: "https://app.payhero.co.ke/lipwa/1068",
        width: "100%",
        height: "100%",
        containerId: "payHero",
        channelID: 1159,
        amount,
        phone,
        name: phone,
        reference: "daily_" + Date.now(),
        buttonName: `Pay KES ${amount}`,
        buttonColor: "#00a884"
      });

      status.textContent = "Awaiting payment confirmation...";
    };

    payBtn.addEventListener("click", makePayment);

    // ‚úÖ Handle Payment Success
    window.addEventListener("message", async (event) => {
      if (!event.data?.paymentSuccess) return;

      loader.classList.remove("hidden");
      status.textContent = "‚úÖ Payment confirmed. Updating your access...";

      const phone = document.getElementById("phone").value.trim();
      const amount = parseFloat(document.getElementById("amount").value.trim());
      const daysPaid = Math.floor(amount / 1000);
      const today = new Date();

      const codeRef = ref(db, "DailyPayments/" + FIXED_ACCESS_CODE);
      const snapshot = await get(codeRef);
      let newExpiry;

      if (snapshot.exists()) {
        const oldExpiry = new Date(snapshot.val().expiry);
        if (oldExpiry > today) {
          oldExpiry.setDate(oldExpiry.getDate() + daysPaid);
          newExpiry = oldExpiry;
        } else {
          newExpiry = new Date(today.setDate(today.getDate() + daysPaid));
        }
      } else {
        newExpiry = new Date(today.setDate(today.getDate() + daysPaid));
      }

      // ‚úÖ Save or Update under fixed code
      await set(codeRef, {
        code: FIXED_ACCESS_CODE,
        expiry: newExpiry.toISOString(),
        lastPayment: new Date().toISOString(),
        lastAmount: amount,
        lastPhoneUsed: phone,
        topUpDays: daysPaid
      });

      // Save locally for session
      localStorage.setItem("accessCode", FIXED_ACCESS_CODE);
      localStorage.setItem("expiry", newExpiry.toISOString());

      loader.classList.add("hidden");
      status.classList.remove("text-red-600");
      status.classList.add("text-green-700");
      status.textContent = `‚úÖ Payment successful! Access extended until ${newExpiry.toDateString()}`;

      setTimeout(() => (window.location.href = "index.html"), 2500);
    });
  </script>
</body>
</html>
